<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>지뢰 찾기 / Minesweeper（5×5｜5 Mines）</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #b8860b; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding-top: 20px;
  }
  #board { display: grid; margin: 20px auto; gap: 4px; }
  .cell {
    width: 50px; height: 50px;
    background: #d2b48c;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; font-weight: bold; font-size: 20px; user-select: none;
    color: #1c1c1c;
  }
  .revealed { background: #f5deb3; cursor: default; }
  .mine { background: #8b4513; color: white; }
  .mineHint3 { background: #deb887 !important; }
  .mineHint4 { background: #a0522d !important; }
  #status { margin: 8px 0 12px; font-size: 20px; color: white; }
  .toolbar { display:flex; gap:12px; justify-content:center; align-items:center; }
  button { 
    padding:8px 14px; font-size:16px; cursor:pointer; 
    background:#cd853f; color:white; border:none; border-radius:6px;
  }
  button:hover { background:#a0522d; }
  .mine-img { width: 40px; height: 40px; }
  .hidden { display: none; }
  #secret {
    max-width: 960px; margin: 16px auto 40px;
    background: #fff7e6; color: #3b2f2f;
    padding: 16px 20px; border-radius: 10px;
    border: 2px solid #deb887; line-height: 1.6; white-space: pre-wrap;
  }
  #secret h2 { margin: 0 0 8px; font-size: 20px; }
  #secret hr { border: none; border-top: 1px dashed #deb887; margin: 12px 0; }
  #secret a {
    display: block; margin: 16px auto; padding: 10px 16px;
    background: #22c55e; color: #0b1220; text-decoration: none;
    border-radius: 6px; font-weight: bold; text-align: center;
    width: fit-content;
  }
  #secret a:hover { background:#16a34a; }
  .hint{opacity:.8;margin-top:1rem;font-size:.9rem;text-align:center;color:#fff}
</style>
</head>
<body>
<h1 style="color:white;">지뢰 찾기 / Minesweeper（5×5｜5 Mines）</h1>

<div class="toolbar">
  <button id="restart">다시 시작 / Restart</button>
  <button id="enterCode" class="hidden">비밀번호 입력 / Enter Code</button>
</div>

<p id="status"></p>
<div id="board"></div>
<div id="secret" class="hidden"></div>

<script>
const rows = 5, cols = 5, minesCount = 5;
let board = [], gameOver = false;
let restartCount = 0; 
let minePositions = [];
const restartBtn = document.getElementById("restart");
const enterCodeBtn = document.getElementById("enterCode");
const secretBox = document.getElementById("secret");

const mineImages = ["missile.png", "mine.png", "trap.png", "gun.png", "grenade.png"];

function init() {
  gameOver = false;
  restartCount++;
  document.getElementById("status").textContent = "";
  secretBox.classList.add("hidden");
  secretBox.innerHTML = "";
  restartBtn.classList.remove("hidden");
  enterCodeBtn.classList.add("hidden");

  const boardDiv = document.getElementById("board");
  boardDiv.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
  boardDiv.innerHTML = "";
  board = [];

  for (let r = 0; r < rows; r++) {
    board[r] = [];
    for (let c = 0; c < cols; c++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.addEventListener("click", reveal);
      boardDiv.appendChild(cell);
      board[r][c] = { mine: false, revealed: false, cell, icon: null };
    }
  }

  if (minePositions.length === 0) {
    let placed = 0;
    while (placed < minesCount) {
      const r = Math.floor(Math.random() * rows);
      const c = Math.floor(Math.random() * cols);
      if (!minePositions.some(([rr, cc]) => rr === r && cc === c)) {
        const icon = mineImages[Math.floor(Math.random() * mineImages.length)];
        minePositions.push([r, c, icon]);
        placed++;
      }
    }
  }

  minePositions.forEach(([r, c, icon]) => {
    board[r][c].mine = true;
    board[r][c].icon = icon;
  });

  if (restartCount === 3) {
    minePositions.forEach(([r, c]) => board[r][c].cell.classList.add("mineHint3"));
  } else if (restartCount >= 4) {
    minePositions.forEach(([r, c]) => board[r][c].cell.classList.add("mineHint4"));
  }
}

function reveal() {
  if (gameOver) return;
  const r = +this.dataset.row, c = +this.dataset.col;
  const sq = board[r][c];
  if (sq.revealed) return;

  sq.revealed = true;
  sq.cell.classList.add("revealed");

  if (sq.mine) {
    sq.cell.classList.add("mine");
    sq.cell.innerHTML = `<img src="${sq.icon}" class="mine-img" alt="mine">`;
    document.getElementById("status").textContent = "💥 게임 종료! / Game Over!";
    showAllMines();
    gameOver = true;
    return;
  }

  const count = countMines(r, c);
  if (count > 0) {
    sq.cell.textContent = count;
  } else {
    for (let dr = -1; dr <= 1; dr++) {
      for (let dc = -1; dc <= 1; dc++) {
        const nr = r + dr, nc = c + dc;
        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
          if (!board[nr][nc].revealed) reveal.call(board[nr][nc].cell);
        }
      }
    }
  }

  checkWin();
}

function countMines(r, c) {
  let cnt = 0;
  for (let dr = -1; dr <= 1; dr++) {
    for (let dc = -1; dc <= 1; dc++) {
      const nr = r + dr, nc = c + dc;
      if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
        if (board[nr][nc].mine) cnt++;
      }
    }
  }
  return cnt;
}

function checkWin() {
  let revealedCount = 0;
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      if (board[r][c].revealed) revealedCount++;
    }
  }
  if (revealedCount === rows * cols - minesCount) {
    document.getElementById("status").textContent = "🎉 축하합니다! 승리했습니다! / Congratulations, You Win!";
    showAllMines();
    gameOver = true;
    restartBtn.classList.add("hidden");
    enterCodeBtn.classList.remove("hidden");
  }
}

function showAllMines() {
  minePositions.forEach(([rr, cc, icon]) => {
    const sq = board[rr][cc];
    if (!sq.revealed) {
      sq.cell.classList.add("mine","revealed");
      sq.cell.innerHTML = `<img src="${icon}" class="mine-img" alt="mine">`;
    }
  });
}

enterCodeBtn.addEventListener("click", () => {
  const code = prompt("다섯 자리 비밀번호를 입력하세요 / Please enter the 5-digit code:");
  if (code === null) return;
  const targetURL = "https://sddaassddasd-collab.github.io/meipanoramalaunch/";

  const text = (code === "20197")
    ? `배곧신도시의 역사와 발전 ... （略） ...`
    : `비밀번호가 잘못 입력되었습니다 ...`;

  secretBox.textContent = text;

  // 建立「取代整頁開啟」按鈕
  const link = document.createElement("a");
  link.id = "fallbackLink";
  link.href = targetURL;
  link.target = "_top";
  link.rel = "noopener";
  link.textContent = "계속하기 / Continue";
  secretBox.appendChild(document.createElement("hr"));
  secretBox.appendChild(link);
  secretBox.classList.remove("hidden");

  // 加入 JS 控制行為
  function replaceTop(url) {
    try {
      window.top.location.replace(url);
    } catch (err) {
      console.warn("Top navigation blocked:", err);
      alert("이 페이지는 상위 iframe의 sandbox로 인해 전체 페이지 이동이 제한되었습니다. A 사이트에서 allow-top-navigation-by-user-activation을 추가해주세요.");
      document.getElementById("fallbackLink").click();
    }
  }
  link.addEventListener("click", (e) => {
    e.preventDefault();
    replaceTop(targetURL);
  });
});

restartBtn.addEventListener("click", init);
init();
</script>
</body>
</html>
